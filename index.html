<html>
  <head>
    <title>skills-pointer</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/ui/1.12.0/jquery-ui.min.js"></script>

    <script type="text/javascript" src="js/db.js"></script>
    <script type="text/javascript" src="app.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="app.css">

    <script>
      $(function () {
        $("#main").tabs({active: 0});
        $('#welcome').text('Welcome ' + user.name + '!');
      });
    </script>
  </head>
  <body>
    <div id="title" class="banner">
      <span id="logo">skills-pointer</span>
      <span id="welcome"></span>
    </div>

    <div id="main">
      <ul id="menu" class="banner">
        <li><a href="#find"><i class="material-icons">search</i> find</a></li>
        <li><a href="#recommend"><i class="material-icons">thumb_up</i> recommend</a></li>
        <li class="right"><a href="#settings"><i class="material-icons">settings</i> settings</a></li>
        <li class="right"><a href="#test">test</a></li>
      </ul>

      <div id="find">
        <script>
          function displayRecommendedPeopleForSkills() {
            $("#result_list").empty();
            $("#nobody").hide();

            let $skills = $('#find .skills'); // TODO allow multiple skills
            let recommendations = service.findRecommendedPersonsFor($skills.val());
            if (Object.keys(recommendations).length > 0) {
              for(let id in recommendations) {
                let person=service.findPerson(id);
                $("#result_list").append($(`<li>${person.name} (${person.location}) [${recommendations[id]}]</li>`));
              }
            } else {
              $("#nobody").show();
            }
          }

          $(function () {
            $('#find .skills').change(function() {
              this.blur();
              displayRecommendedPeopleForSkills();
            });
            $('#find button').click(displayRecommendedPeopleForSkills);
          });
        </script>

        <p>Qui pourrait m'aider sur...</p>
        <input class="skills" type="text" autocomplete="off" placeholder="ex : angular">
        <button>OK</button>
        <div id="result">
          <ul id="result_list"></ul>        
        </div>
        <div id="nobody" style="display: none;">
          <p>Personne ne peut vous aider</p>
          <img src="img/Appel%20Ã %20ami.webp" width="100">
        </div>
      </div>

      <div id="recommend">
        <script>
          function recommend() {
            let $name = $('#recommend .name');
            let $skill = $('#recommend .skill');

            let candidates = service.findPersons($name.val());
            let recommendee;
            if (candidates.length == 0) {
              let id = persons.length;
              recommendee = {
                'id': personId,
                'name': $name.val(),
                'location': 'Meylan'
              };
              persons.push(recommendee);
            } else {
              recommendee = candidates[0];
            }

            recommendation = {recommender: user.id, recommendee: recommendee.id, skill: $skill.val()};
            recommendations.push(recommendation);

            db.set('persons', persons);
            db.set('recommendations', recommendations);

            $name.val('');
            $skill.val('');
          }
        </script>

        <p>Mon coll&egrave;gue
          <input class="name" type="text" placeholder="ex: Marie">
          m'a aid&eacute; avec
          <input class="skill" type="text" placeholder="ex : angular">
          <button onclick="recommend()">recommander</button>
        </p>
        <div id="result"></div>
      </div>

      <div id="settings">
        <h3>persons</h3>
        <div id="persons"></div>
        <h3>recommendations</h3>
        <div id="recommendations"></div>
        <script>
          $(function () {
            $('#persons').text(JSON.stringify(persons));
            $('#recommendations').text(JSON.stringify(recommendations));
          });
        </script>
      </div>

      <div id="test">
        <script>
          $(function () {
            function test(title, boolOrFunc) {
              let success;
              try {
                success = typeof boolOrFunc === 'function' ? boolOrFunc() : boolOrFunc;
              } catch (e) {
                console.log(e);
                success = false;
              }
              let style = success ? 'green' : 'red';
              $('#test').append(`<div style="color: ${style}">${title}</div>`);
            }

            let service = new Service('skill-pointer-test');
            service.reset();

            test('find person by id', () => {
              let p = service.findPerson(1);
              return p && p.name=='Mary Doe';
            });
            
            test('find persons by "query"', () => {
              let p = service.findPersons('Doe');
              return p.length==2;
            });
            
            let personsWithAndroidSkills;
            test('find recommended persons for Android skills', () => {
              personsWithAndroidSkills = service.findRecommendedPersonsFor('android');
              return personsWithAndroidSkills instanceof Object;
            });
            test('* must find 3 persons', Object.keys(personsWithAndroidSkills).length === 3);
            test('* must indicate 2 recommendations for person 3', personsWithAndroidSkills[3] === 2);
          });
        </script>
      </div>
    </div>
  </body>
</html>